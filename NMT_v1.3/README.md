# NMT - NIMH Macaque Template

For any issues or questions, contact Jakob Seidlitz at jakob.seidlitz@nih.gov or jms290@cam.ac.uk.

## Description
The National Institute of Mental Health (NIMH) Macaque Template (NMT) is an anatomical structural MRI template of the macaque brain. It was created using the freely available software package [ANTs](http://stnava.github.io/ANTs/). The NMT is technically the non-linear diffeomorphic average of T1-weighted Modified Driven Equilibrium Fourier Transform (MDEFT) scans from 31 adult rhesus macaque brains, generated by iteratively registering and averaging each individual subject to a common space. For more information on the template creation process, see [our paper](http://www.sciencedirect.com/science/article/pii/S105381191730383X).

This README file provides an overview of the NMT MRI volume and its associated volume and surface files. Sample commands for visualizing the surfaces are listed as well, using [SUMA](https://afni.nimh.nih.gov/afni/suma) from the [AFNI](https://afni.nimh.nih.gov) software suite.

The NMT and it's associated masks, parcellations and atlases may be previewed in your browser by visiting our [Neurovault repository]( https://neurovault.org/collections/4500/).

## Citation

If you use this repository, please cite the paper below:

	Seidlitz, J., Sponheim, C., Glen, D., Ye, F.Q., Saleem, K.S., Leopold, D.A., Ungerleider, L., Messinger, A.
		A population MRI brain template and analysis tools for the macaque. *NeuroImage* (2017).
		doi: [10.1101/105874](http://www.sciencedirect.com/science/article/pii/S105381191730383X)

Use of the D99 atlas (warped to the NMT in this repository) should be accompanied with the following citation:

	Three-dimensional digital template atlas of the macaque brain
		Reveley, Gruslys, Ye, Glen, Samaha, Russ, Saad, Seth, Leopold, Saleem
		Cerebral Cortex, Aug 2016.

## Download

To download from the terminal, navigate to the directory where you want to store the NMT repository. Then, copy and paste this command:
```bash
git clone http://github.com/jms290/NMT.git
```

Otherwise, on the [NMT repository homepage](https://github.com/jms290/NMT), click the green button "clone or download"...

Alternatively, all files associated with the NMT may be downloaded straight from the AFNI website [here](https://afni.nimh.nih.gov/NMT)

------------------

## NMT_v1.3 Changelog
NMT_v1.31
- Added -o option to NMT_subject_pipeline to manually specify output directory
NMT_v1.3
- NMT voxel values have been rescaled and capped to fit within the short datatype.
- NMT files and processing outputs are now properly labeled as being in NMT space
- Modified NMT processing scripts, and added new wrapper pipeline (NMT_subject_pipeline)
- Converted all integer-based NMT volumes from float to short datatype.
- Modified all NMT masks to reflect previous changes to the brainmask
- Removed artifacts around the border of the NMT brainmask generated by N4 Bias Correction of the NMT
- Improved D99 macaque atlas nonlinear alignment to the NMT

## NMT Files

All volume and surface files are stored in the relatively universal nifti (.nii.gz) and gifti (.gii) formats, to be compatible with a plethora of software packages. Additional files are provided to be compatible with AFNI's atlas and surface viewing capabilities.

- NMT volume (with skull) - **NMT.nii.gz**
- NMT volume (without skull) - **NMT_SS.nii.gz**
- Masks
	+ NMT Brain Masks
		- NMT Binary Brainmask **NMT_brainmask.nii.gz**
		- NMT cerebellum - **NMT_cerebellum_mask.nii.gz**
		- NMT olfactory bulb - **NMT_olfactory_bulb_mask.nii.gz**
		- NMT arterial blood vasculature - **NMT_blood_vasculature_mask.nii.gz**
		- NMT 4-tissue segmentation mask (including arterial blood vasculature) - **NMT_segmentation_4class.nii.gz**
	+ NMT Probabilisitic Tissue Segmentation Masks
		- NMT Probabilisitic Brainmask **NMT_brainmask_prob.nii.gz**
		- Gray matter - **NMT_segmentation_GM.nii.gz**
		- White matter - **NMT_segmentation_WM.nii.gz**
		- Cerebral spinal fluid - **NMT_segmentation_CSF.nii.gz**
	+ NMT Cortical Masks
		- NMT cortical cortical thickness mask - **NMT_CT.nii.gz**
		- NMT cortical gray matter mask - **NMT_GM_cortical_mask.nii.gz**
		- NMT cortical gray matter mask with white matter - **NMT_GM_cortical_mask_withWM.nii.gz**
- Surfaces
	+ Gray matter surface - **[lh or rh].GM.gii**
	+ White matter surface - **[lh or rh].WM.gii**
	+ Mid-cortical surface - **[lh or rh].mid.gii**
	- NMT surfaces (inflated)
		+ Gray matter surface - **[lh or rh].GM_inflated.gii**
		+ White matter surface - **[lh or rh].WM_inflated.gii**
		+ Mid-cortical surface - **[lh or rh].mid_inflated.gii**
	- NMT surfaces (other)
		+ Arterial blood vasculature - **blood_vasculature.gii**
		+ Cerebellum surface - **cerebellum.gii**
- Common Atlases Aligned to the NMT
	+ D99 Atlas Aligned to NMT - **D99_atlas_1.2a_al2NMT.nii.gz**
	+ F99 Transformation Parameters ([AFNI website](https://afni.nimh.nih.gov/pub/dist/atlases/macaque/nmt/NMT_v1.2/volumetric_transformations/))- **/F99_volumetric_transformations**
- NMT Alignment and Processing Scripts
	+ NMT_subject_align - **NMT_subject_align.csh**
	+ NMT_subject_process - **NMT_subject_process**
	+ NMT_subject_morph - **NMT_subject_morph**
	+ NMT_subject_pipeline - **NMT_subject_pipeline**


In the **surfaces/** folder, there is a .spec file - **NMT_both.spec**, which is a text file used by SUMA to load in each of the left and right hemisphere surfaces above.

## Visualization in AFNI/SUMA

For those new to AFNI/SUMA, we recommend that you use the quick_view.csh script. This script will automatically open the NMT surfaces in SUMA and the NMT in AFNI.

Navigate to the directory where you have stored the NMT repository. Then follow these steps:
```bash
afni -niml &
```
This will start AFNI and tell AFNI that a connection with SUMA is imminent. Load in NMT.nii.gz as the underlay if it is not loaded automatically. Then, back in the terminal, run:
```bash
suma -spec ./NMT_both.spec -sv ./NMT.nii.gz &
```
This should start SUMA, and you should see the left and right WM surfaces. To switch to a different set of surfaces, move your cursor into the SUMA window and toggle the "." key. For other navigational shortcuts and tools, see the [SUMA documentation](https://afni.nimh.nih.gov/sscc/staff/ziad/SUMA/SUMA_do1.htm).

Toggle the "t" key to open the connection between AFNI and SUMA. You should see various outlines on the NMT volume in AFNI that correspond with the surfaces loaded into SUMA. To edit or remove the outlines in AFNI, toggle the "Control Surface" button in the AFNI GUI.

Now that AFNI and SUMA are linked, this will allow you to visualize any data (i.e. overlay) from the NMT volume on the surface. Note that only the voxels which intersect the surface outlines will be plotted on the surface. As such, we suggest using the "mid" surface for the visualization of any functional MRI data. For more information about using AFNI interactively, see this [slide show](https://afni.nimh.nih.gov/pub/dist/edu/latest/afni_handouts/afni03_interactive.pdf).

### D99 Atlas
We provide the D99 atlas nonlinearly warped to the NMT (**D99_atlas_1.2a_al2NMT.nii.gz**). This version of the D99 has been nonlinearly warped to the NMT volume, and the cortical regions have been modified to better fill the cortical sheet and to avoid labels in the CSF.

Before viewing the D99 atlas, we recommend running the **NMT_env.csh** script so that AFNI may recognize the D99 atlas aligned to the NMT as an atlas. Atlases may be further warped to the single subject space (see Single-Subject Processing) or utilized in the NMT for ROI-based analyses. Use of the D99 atlas should be accompanied with the following citation:

	Three-dimensional digital template atlas of the macaque brain
		Reveley, Gruslys, Ye, Glen, Samaha, Russ, Saad, Seth, Leopold, Saleem
		Cerebral Cortex, Aug 2016.
### F99 Atlas
Furthermore, we include the rigid, affine, and diffeomorphic (non-linear) tranformations to the NMT from the F99 template [here](https://afni.nimh.nih.gov/pub/dist/atlases/macaque/nmt/NMT_v1.2/volumetric_transformations/). An example command to align the F99 atlas to the NMT (using AFNI's [3dNwarpApply](https://afni.nimh.nih.gov/pub/dist/doc/program_help/3dNwarpApply.html) command) is provided below:

```bash
3dNwarpApply -nwarp 'Macaque.F99UA1.LR.03-11_SurfVol_shft.1D \
	 Macaque.F99UA1.LR.03-11_SurfVol_shft_al2std_mat.aff12.1D \
	 Macaque.F99UA1.LR.03-11_SurfVol_shft_WARP.nii.gz' \
	 -source {F99_atlas_name}  -ainterp NN -short \
	 -master NMT.nii.gz -prefix F99_atlas_al2NMT.nii.gz
```

To go from the NMT to the F99 simply reverse the order of the transformations and add the INV() to each transformation file:

```bash
3dNwarpApply -nwarp 'INV(Macaque.F99UA1.LR.03-11_SurfVol_shft_WARP.nii.gz) \
	INV(Macaque.F99UA1.LR.03-11_SurfVol_shft_al2std_mat.aff12.1D) \
	INV(Macaque.F99UA1.LR.03-11_SurfVol_shft.1D)' \
	-source NMT.nii.gz -ainterp NN -short \
	-master {F99_atlas_name} -prefix NMT_in_F99_atlas.nii.gz
```

------------------

## Single-Subject Processing

Along with the NMT dataset, we provide scripts to automated the processing of single subjects.
See the [paper](http://www.sciencedirect.com/science/article/pii/S105381191730383X) as well as the table in the [supplemental material](https://ars.els-cdn.com/content/image/1-s2.0-S105381191730383X-mmc1.docx) for more information. Below is the usage for each script.

For help with using the single-subject processing tools, we recommend running our example script, align_and_process_tutorial.csh in the Example_Subject/ folder. This script will run the NMT processing scripts on our Example_Subject so that you can see how the scripts should be run and the format of the output files.

***-Only a reconstructed T1-weighted scan/volume is needed (either AFNI (.BRIK/.HEAD) or NIFTI (.nii or .nii.gz) format)***

### NMT_subject_align
The **NMT_subject_align script** generates the rigid (6 parameter), affine (12 parameter), and non-linear (voxelwise) transformations to and from the NMT. The **NMT_subject_process** and **NMT_subject_morph** scripts depend on these transformations.
#### Usage
Create a directory in single_subject_scans/ directory in the NMT distribution, and copy the scan of the individual subjects into this new directory. Run this script using a single scan as input, along with the NMT and NMT_subject_align.csh in the parent directory, as below:
```bash
bash ../../NMT_subject_align -i [subject] -r ../../NMT.nii.gz
```
If the brain has already been masked out from your subject (i.e., skull-stripped), utilize the skull-stripped version of the NMT (NMT_SS.nii.gz) as input to NMT_subject_align, as below:

```bash
bash ../../NMT_subject_align -i [subject] -r ../../NMT_SS.nii.gz
```

We also provide the ability to automate the alignment of a given atlas through NMT_subject_align:
```bash
bash ../../NMT_subject_align -i [subject] -r ../../NMT_SS.nii.gz -a ../../D99_atlas_1.2a_al2NMT.nii.gz
```

Sometimes, the default nonlinear alignment parameters may not be sufficient to produce a satisfactory warp, you can modify by modifying the -w flag, which modifies AFNI's 3dQwarp -qworkhard flag (default = 2; max = 9):
```bash
bash ../../NMT_subject_align -i [subject] -r ../../NMT_SS.nii.gz -w 9
```


NMT_subject_align provides multiple outputs to assist in registering your anatomicals and associated MRI data to the NMT:
- Subject scan registered to the NMT
 + **mydset_rigid.nii.gz** - datawith rigid-body alignment to the NMT
 + **mydset_rigid_aff.nii.gz** - datawith affine alignment to the NMT
 + **mydset_warp2std.nii.gz** - datawith nonlinear alignment to the NMT
- Registration parameters for Alignment to NMT
 + **mydset_rigid_mat.aff12.1D** - Rigid-body transformation parameters to the NMT
 + **mydset_affine_mat.aff12.1D** - Affine transformation parameters to the NMT
 + **mydset_composite_linear_to_NMT.1D** - Combined rigid-body and affine transformations to the NMT
 + **mydset_WARP.nii.gz** - warp deformations to the NMT from nonlinear alignment only
- Registration parameters for NMT Alignment to Subject
 + **mydset_rigid_mat_inv.aff12.1D** - inverse of mydset_rigid_mat.aff12.1D
 + **mydset_affine_mat_inv.aff12.1D** - inverse of mydset_affine_mat.aff12.1D
 + **mydset_composite_linear_to_NMT_inv.1D** - inverse of mydset_composite_linear_to_NMT.1D
 + **mydset_WARPINV.nii.gz** - inverse of mydset_WARP.nii.gz
- Specified Atlas Aligned to Single Subject (Optional)
 + **mask_in_mydset.nii.gz** - D99 Atlas or other mask aligned to native scan
-qc/: A directory containing montages of the aligned volumes for assessing alignment accuracy.

 Here all occurrences of mydset the output file names would be replaced with the name of your dataset

***-NOTE: NMT_subject_align requires the AFNI software package to run correctly***

Data aligned to your dataset can be easily warped to the NMT using NMT_subject_align outputs and AFNI's 3dNwarpApply:
```bash
3dNwarpApply -nwarp {mydset}_WARP.nii.gz {mydset}_composite_linear_to_NMT.1D \
	-source {newdset}_in_NMT_aff.nii.gz -master ../../NMT.nii.gz -ainterp wsinc5 \
	-prefix {newdset}_in_NMT.nii.gz
```

To bring data from the NMT to your dataset, simply use the inverse transformations of the above commands:
```bash
3dNwarpApply -nwarp {mydset}_composite_linear_to_NMT_inv.1D {mydset}_WARPINV.nii.gz \
	-source {newdset}+orig -master {mydset}+orig -prefix {NMTdset}_in_{mydset}_nl.nii.gz
```

When warping atlas or mask data, add the -ainterp NN flag to avoid warping artifacts.


### NMT_subject_process
**NMT_subject_process** performs N4 bias field correction for normalizing intensity non-uniformities, and generates a brain mask (for skull-stripping) as well as probabilistic tissue segmentation masks (GM, WM, CSF).
#### Usage
```bash
bash ../../NMT_subject_process [subject]
```

Run this script from the directory where the NMT_subject_align output lies. This script will create a directory NMT_subject_process with the corresponding masks in the subject's anatomical space.

Occasionally, antsBrainExtraction (used in NMT_subject_process for skull-stripping) will fail to accurately skull strip your individual data. In these instances, you can use the inverse of the nonlinear registration calculated in NMT_subject_align to warp the NMT's brainmask to your scan as an approximation. This can be done automatically in NMT_subject_process by adding a 0 at the end of the command:

```bash
bash ../../NMT_subject_process [subject] 0
```

***-NOTE: NMT_subject_process requires AFNI and [ANTs](http://stnava.github.io/ANTs/) to be installed***

### NMT_subject_morph
**NMT_subject_morph** uses the NMT's cortical GM mask to produce volumetric maps of cortical thickness, surface area, and mean and gaussian (i.e., intrinsic) curvature.
#### Usage
```bash
bash ../../NMT_subject_morph [subject]
```

Run this script from the directory where the NMT_subject_align output lies. This script will create a directory NMT_subject_morph with the corresponding masks in the subject's anatomical space.

***-NOTE: NMT_subject_morph requires AFNI and [ANTs](http://stnava.github.io/ANTs/) to be installed***

### NMT_subject_pipeline
The **NMT_subject_pipeline script** will automatically process your data through the **NMT_subject_align**, **NMT_subject_process** and **NMT_subject_morph** scripts. The outputs of NMT_subject_pipeline will include the rigid (6 parameter), affine (12 parameter), and non-linear (voxelwise) transformations to and from the NMT; individual scan N4 normalization, brainmasking and segmentation; and various morphometric maps for your scan.

#### Usage
Run this script using a single scan as input, along with the NMT template meant to serve as the reference volume, as below:
```bash
bash NMT_subject_pipeline -i [subject] -r [NMT_PATH]/NMT.nii.gz
```

The script will create a directory named **single_subject_scans/** in the same directory as the NMT and it will create a directory inside of single_subject_scans/ named after your individual scan. All outputs from NMT_subject_pipeline will be stored within this directory.

Optional flags in **NMT_subject_align** and **NMT_subject_process** may be accessed through **NMT_subject_pipeline**:
```bash
bash NMT_subject_pipeline -i [subject] -r [NMT_PATH]/NMT.nii.gz -a D99_atlas_1.2a_al2NMT.nii.gz -w 9 -b 1
```

See **NMT_subject_pipeline** help for more information.

***-NOTE: NMT_subject_pipeline requires the AFNI and ANTs software packages to run correctly***
